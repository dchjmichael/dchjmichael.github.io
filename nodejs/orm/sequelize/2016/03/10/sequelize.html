<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Joey's Blog - 技术学习，笔记，分享</title>
    <meta name="description" content="技术学习，笔记，分享" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />

</head>
<body class="home-template">

    <header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="back-button icon-arrow-left" href="/">Home</a>
        <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
    </nav>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">NodeJS ORM框架Sequelize学习笔记</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2016-03-10">10 Mar 2016</time>
                
                    on NodeJS, ORM, and Sequelize
                
            </section>
        </header>

<!--         <header class="post-header">
            <a id="blog-logo" href="https://dchjmichael.github.io">
                
                    <span class="blog-title">Joey's Blog</span>
                
            </a>
        </header> -->

        <!-- <span class="post-meta">
            <time datetime="2016-03-10">10 Mar 2016</time>
            
                on NodeJS, ORM, and Sequelize
            
        </span> -->

        <!-- <h1 class="post-title">NodeJS ORM框架Sequelize学习笔记</h1> -->

        <section class="post-content">
            <p><a href="https://github.com/sequelize/sequelize">Sequelize</a>是一个基于Promise的ORM框架，支持PostgreSQL，MySQL，MariaDB，SQLite以及MSSQL，支持事务，关系映射，读复制等。</p>

<h2>设置</h2>

<h3>安装</h3>
<div class="highlight"><pre><code class="language-sh" data-lang="sh">npm install --save sequelize

<span class="c"># 任选其一:</span>
<span class="nv">$ </span>npm install --save pg pg-hstore //PostgreSQL
<span class="nv">$ </span>npm install --save mysql // mysql和mariaDB都用这个
<span class="nv">$ </span>npm install --save sqlite3
<span class="nv">$ </span>npm install --save tedious // MSSQL
</code></pre></div>
<h3>初始化</h3>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span>  <span class="nx">Sequelize</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;sequelize&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="s1">&#39;dbname&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="nx">dialect</span><span class="o">:</span> <span class="s1">&#39;postgres&#39;</span><span class="p">,</span>

    <span class="nx">pool</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">max</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">min</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">idle</span><span class="o">:</span> <span class="mi">10000</span>
    <span class="p">},</span>

<span class="p">});</span>

<span class="c1">// 或者直接通过uri创建连接</span>
<span class="kd">var</span> <span class="nx">sequelize</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(</span><span class="s1">&#39;postgres://user:pass@example.com:5432/dbname&#39;</span><span class="p">);</span>
</code></pre></div>
<p><a href="http://sequelize.readthedocs.org/en/latest/api/sequelize/">所有参数</a></p>

<h3>定义模型</h3>

<p><code>define(modelName, attributes, [options])</code></p>

<ul>
<li>modelName 模型名，不是数据库表名</li>
<li>attributes 属性定义，</li>
<li>选项</li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">Author</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">authorId</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">BIGINT</span><span class="p">,</span>
        <span class="nx">field</span><span class="o">:</span> <span class="s1">&#39;author_id&#39;</span><span class="p">,</span>
        <span class="nx">primaryKey</span><span class="o">:</span><span class="kc">true</span> <span class="c1">//定义为主键</span>
    <span class="p">},</span>
    <span class="nx">authorName</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
        <span class="nx">field</span><span class="o">:</span><span class="s1">&#39;author_name&#39;</span>
    <span class="p">}</span>
<span class="p">},</span> <span class="p">{</span>
    <span class="nx">tableName</span><span class="o">:</span><span class="s1">&#39;tbl_author&#39;</span><span class="p">,</span>
    <span class="nx">timestamps</span><span class="o">:</span><span class="kc">false</span>

    <span class="c1">//sequelize会在模型定义的时候自动添加createdAt和updatedAt属性，这样我们可以知道每行记录的变更时间</span>
  <span class="c1">//如果不想要这个特性，可以把timestamps置为false</span>
 <span class="c1">// timestamps: false,</span>

  <span class="c1">//不要删除记录，而是添加一个deletedAt属性，只有在timestamps启用的情况下才有效。</span>
  <span class="c1">//paranoid: true,</span>


  <span class="c1">//不对自动添加的属性使用驼峰命名法，而是用下划线风格。</span>
  <span class="c1">//因此updatedAt变成udpated_at</span>
  <span class="c1">//underscored: true,</span>

  <span class="c1">//禁止修改表名，sequelize默认会把所有模型的名字（define方法的第一个参数）转成复数</span>
  <span class="c1">//不需要的话就设成true，这样模型名就是表名</span>
  <span class="c1">//freezeTableName: true,</span>

  <span class="c1">//自定义表名</span>
  <span class="c1">//tableName: &#39;my_very_custom_table_name&#39;</span>

<span class="p">});</span>

<span class="kd">var</span> <span class="nx">Book</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;book&#39;</span><span class="p">,{</span>
    <span class="nx">bookId</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span><span class="nx">Sequelize</span><span class="p">.</span><span class="nx">BIGINT</span><span class="p">,</span>
        <span class="nx">field</span><span class="o">:</span><span class="s1">&#39;book_id&#39;</span><span class="p">,</span>
        <span class="nx">primaryKey</span><span class="o">:</span><span class="kc">true</span>
    <span class="p">},</span>
    <span class="nx">authorId</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span><span class="nx">Sequelize</span><span class="p">.</span><span class="nx">BIGINT</span><span class="p">,</span>
        <span class="nx">field</span><span class="o">:</span><span class="s1">&#39;author_id&#39;</span><span class="p">,</span>
        <span class="nx">foreignKey</span><span class="o">:</span><span class="kc">true</span>
    <span class="p">},</span>
    <span class="nx">title</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span><span class="nx">Sequelize</span><span class="p">.</span><span class="nx">STRING</span><span class="p">,</span>
        <span class="nx">field</span><span class="o">:</span><span class="s1">&#39;book_title&#39;</span>
    <span class="p">}</span>
<span class="p">},{</span>
    <span class="nx">tableName</span><span class="o">:</span> <span class="s1">&#39;tbl_book&#39;</span><span class="p">,</span>
    <span class="nx">timestamps</span><span class="o">:</span> <span class="kc">false</span>
<span class="p">});</span>
</code></pre></div>
<p><a href="http://sequelize.readthedocs.org/en/latest/docs/models-definition/">详细文档</a></p>

<h2>查询</h2>

<p>查询返回的是model实例而不是普通对象。</p>

<p><code>Model.findXXX(params)</code></p>

<p>params是查询条件，如<code>{where : { authorName : &#39;joe&#39;} , attributes :[&#39;id&#39;,[&#39;name&#39;,&#39;title&#39;]]}</code>,<code>attributes</code>表示返回指定的列，上例表示返回id和name这2列，但是name返回的时候转成title，也就是<code>select id , name as title from table_name</code>。</p>

<ul>
<li><p><code>findById(1)</code>  </p>

<p>根据主键查找，需要在模型中设置primaryKey，默认主键名为“id”.</p></li>
<li><p><code>findByPrimary(1)</code></p>

<p>同<code>findById</code></p></li>
<li><p><code>findOne</code></p>

<p><code>findOne</code>返回模型实例</p></li>
<li><p><code>findAll</code> </p>

<p><code>findAll</code>返回数组，也可以用<code>all()</code></p></li>
<li><p><code>findOrCreate</code>    </p>

<p>查询指定的1个元素，如果找不到就插入一个新的。</p></li>
<li><p><code>findAndCountAll</code></p></li>
</ul>

<p>查询指定的对象，并且返回符合条件的数量，这个在分页的时候比较有用。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">exec</span><span class="p">(</span><span class="nx">Model</span><span class="p">,</span> <span class="nx">Func</span><span class="p">,</span> <span class="nx">Params</span> <span class="p">,</span><span class="nx">spread</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">future</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">[</span><span class="nx">Func</span><span class="p">](</span><span class="nx">Params</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">spread</span><span class="p">){</span>
        <span class="nx">future</span><span class="p">.</span><span class="nx">spread</span><span class="p">(</span>
            <span class="p">(</span><span class="nx">user</span> <span class="p">,</span> <span class="nx">created</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">user</span> <span class="p">,</span> <span class="kc">null</span> <span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">created</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">future</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span>
            <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">user</span> <span class="p">,</span> <span class="kc">null</span> <span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//exec(Author,&#39;findByPrimary&#39;,1);</span>
<span class="c1">//exec(Author, &#39;findOne&#39;, {where: {authorName: &#39;jbl&#39;}});</span>
<span class="c1">//exec(Author, &#39;findAll&#39;, {where: {authorName: &#39;jb&#39;}});</span>
<span class="c1">//exec(Author, &#39;all&#39;, {where: {authorName: &#39;jbl&#39;}});</span>

<span class="c1">//Author.findOrCreate({where:{}})</span>
<span class="c1">//exec(Author, &#39;findOrCreate&#39;, {where: {authorName: &#39;newAUthor&#39;} , defaults:{authorId:4,authorName:&#39;newAUthor&#39;}}  , true);</span>
<span class="c1">//exec(Author,&#39;findAndCountAll&#39;,{where:{authorName:&#39;jbl&#39;},limit:1,offset:0});</span>
</code></pre></div>
<h3>Raw查询</h3>

<p>返回原始数据，不对返回的记录生成增，删，改等方法。这在大数据集的时候很有用。方法是在查询时设置<code>{raw:true}</code></p>

<h3>饥渴加载</h3>

<p>使用<code>include</code>在查询时顺便获取关联的数据，比如：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="err">定义模型</span>
<span class="kd">var</span> <span class="nx">User</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">STRING</span> <span class="p">})</span>
  <span class="p">,</span> <span class="nx">Task</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">STRING</span> <span class="p">})</span>
  <span class="p">,</span> <span class="nx">Tool</span> <span class="o">=</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">define</span><span class="p">(</span><span class="s1">&#39;tool&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">STRING</span> <span class="p">})</span>

<span class="nx">Task</span><span class="p">.</span><span class="nx">belongsTo</span><span class="p">(</span><span class="nx">User</span><span class="p">)</span>
<span class="nx">User</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="nx">Task</span><span class="p">)</span>
<span class="nx">User</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="nx">Tool</span><span class="p">,</span> <span class="p">{</span> <span class="nx">as</span><span class="o">:</span> <span class="s1">&#39;Instruments&#39;</span> <span class="p">})</span>

<span class="c1">//User对应多个Task，Tool</span>

<span class="c1">//同步表结构</span>
<span class="nx">sequelize</span><span class="p">.</span><span class="nx">sync</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// this is where we continue ...</span>
<span class="p">})</span>
</code></pre></div>
<p>让我们在加载task时加载User：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">Task</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({</span> <span class="nx">include</span><span class="o">:</span> <span class="p">[</span> <span class="nx">User</span> <span class="p">]</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">tasks</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">tasks</span><span class="p">))</span>

  <span class="cm">/*</span>
<span class="cm">    [{</span>
<span class="cm">      &quot;name&quot;: &quot;A Task&quot;,</span>
<span class="cm">      &quot;id&quot;: 1,</span>
<span class="cm">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span>
<span class="cm">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span>
<span class="cm">      &quot;userId&quot;: 1,</span>
<span class="cm">      &quot;user&quot;: {</span>
<span class="cm">        &quot;name&quot;: &quot;John Doe&quot;,</span>
<span class="cm">        &quot;id&quot;: 1,</span>
<span class="cm">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span>
<span class="cm">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;</span>
<span class="cm">      }</span>
<span class="cm">    }]</span>
<span class="cm">  */</span>
<span class="p">})</span>
</code></pre></div>
<p>注意返回的<code>user</code>是单数的，因为是Task和User是1:1的。</p>

<p>下面来个多关联的：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">User</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({</span> <span class="nx">include</span><span class="o">:</span> <span class="p">[</span> <span class="nx">Task</span> <span class="p">]</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">users</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">users</span><span class="p">))</span>

  <span class="cm">/*</span>
<span class="cm">    [{</span>
<span class="cm">      &quot;name&quot;: &quot;John Doe&quot;,</span>
<span class="cm">      &quot;id&quot;: 1,</span>
<span class="cm">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span>
<span class="cm">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span>
<span class="cm">      &quot;tasks&quot;: [{ //这里是复数，因为多个关联</span>
<span class="cm">        &quot;name&quot;: &quot;A Task&quot;,</span>
<span class="cm">        &quot;id&quot;: 1,</span>
<span class="cm">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span>
<span class="cm">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:40.000Z&quot;,</span>
<span class="cm">        &quot;userId&quot;: 1</span>
<span class="cm">      }]</span>
<span class="cm">    }]</span>
<span class="cm">  */</span>
<span class="p">})</span>
</code></pre></div>
<p>可以用<code>as</code>指定关联的别名：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">User</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({</span> <span class="nx">include</span><span class="o">:</span> <span class="p">[{</span> <span class="nx">model</span><span class="o">:</span> <span class="nx">Tool</span><span class="p">,</span> <span class="nx">as</span><span class="o">:</span> <span class="s1">&#39;Instruments&#39;</span> <span class="p">}]</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">users</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">users</span><span class="p">))</span>

  <span class="cm">/*</span>
<span class="cm">    [{</span>
<span class="cm">      &quot;name&quot;: &quot;John Doe&quot;,</span>
<span class="cm">      &quot;id&quot;: 1,</span>
<span class="cm">      &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span>
<span class="cm">      &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span>
<span class="cm">      &quot;Instruments&quot;: [{ // 使用了as指定的别名</span>
<span class="cm">        &quot;name&quot;: &quot;Toothpick&quot;,</span>
<span class="cm">        &quot;id&quot;: 1,</span>
<span class="cm">        &quot;createdAt&quot;: null,</span>
<span class="cm">        &quot;updatedAt&quot;: null,</span>
<span class="cm">        &quot;userId&quot;: 1</span>
<span class="cm">      }]</span>
<span class="cm">    }]</span>
<span class="cm">  */</span>
<span class="p">})</span>
</code></pre></div>
<p>在饥渴加载的时候也可以用<code>where</code>对关联的模型进行过滤，下面会返回用户的符合<code>where</code>条件的Tool：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">User</span><span class="p">.</span><span class="nx">findAll</span><span class="p">({</span>
    <span class="nx">include</span><span class="o">:</span> <span class="p">[{</span>
        <span class="nx">model</span><span class="o">:</span> <span class="nx">Tool</span><span class="p">,</span>
        <span class="nx">as</span><span class="o">:</span> <span class="s1">&#39;Instruments&#39;</span><span class="p">,</span>
        <span class="nx">where</span><span class="o">:</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$like</span><span class="o">:</span> <span class="s1">&#39;%ooth%&#39;</span> <span class="p">}</span> <span class="p">}</span> <span class="c1">//Tool名字模糊匹配ooth</span>
    <span class="p">}]</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">users</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">users</span><span class="p">))</span>

    <span class="cm">/*</span>
<span class="cm">      [{</span>
<span class="cm">        &quot;name&quot;: &quot;John Doe&quot;,</span>
<span class="cm">        &quot;id&quot;: 1,</span>
<span class="cm">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span>
<span class="cm">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span>
<span class="cm">        &quot;Instruments&quot;: [{</span>
<span class="cm">          &quot;name&quot;: &quot;Toothpick&quot;,</span>
<span class="cm">          &quot;id&quot;: 1,</span>
<span class="cm">          &quot;createdAt&quot;: null,</span>
<span class="cm">          &quot;updatedAt&quot;: null,</span>
<span class="cm">          &quot;userId&quot;: 1</span>
<span class="cm">        }]</span>
<span class="cm">      }],</span>

<span class="cm">      [{</span>
<span class="cm">        &quot;name&quot;: &quot;John Smith&quot;,</span>
<span class="cm">        &quot;id&quot;: 2,</span>
<span class="cm">        &quot;createdAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span>
<span class="cm">        &quot;updatedAt&quot;: &quot;2013-03-20T20:31:45.000Z&quot;,</span>
<span class="cm">        &quot;Instruments&quot;: [{</span>
<span class="cm">          &quot;name&quot;: &quot;Toothpick&quot;,</span>
<span class="cm">          &quot;id&quot;: 1,</span>
<span class="cm">          &quot;createdAt&quot;: null,</span>
<span class="cm">          &quot;updatedAt&quot;: null,</span>
<span class="cm">          &quot;userId&quot;: 1</span>
<span class="cm">        }]</span>
<span class="cm">      }],</span>
<span class="cm">    */</span>
  <span class="p">})</span>
</code></pre></div>
<h2>关联</h2>

<ul>
<li>hasOne - 在目标模型上添加一个外键来进行单关联</li>
<li>belongsTo - 在当前模型上添加一个外键来进行单关联</li>
<li>hasMany - 在目标模型上添加一个外键来进行多关联</li>
<li>belongsToMany - 用join表的方式来创建N:M的关联，连接表是通过sourceId和targetId来创建的。</li>
</ul>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//Author有多个Book</span>
<span class="nx">Author</span><span class="p">.</span><span class="nx">hasMany</span><span class="p">(</span><span class="nx">Book</span><span class="p">,{</span>
    <span class="nx">foreignKey</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span><span class="s1">&#39;authorId&#39;</span><span class="p">,</span>
        <span class="nx">allowNull</span><span class="o">:</span><span class="kc">false</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Book</span><span class="p">.</span><span class="nx">belongsTo</span><span class="p">(</span><span class="nx">Author</span><span class="p">,{</span>
    <span class="nx">foreignKey</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">name</span><span class="o">:</span><span class="s1">&#39;authorId&#39;</span><span class="p">,</span><span class="c1">//每个Book对应一个Author</span>
        <span class="nx">allowNull</span><span class="o">:</span><span class="kc">false</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="nx">exec</span><span class="p">(</span><span class="nx">Author</span><span class="p">,</span> <span class="s1">&#39;findAll&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">where</span><span class="o">:</span> <span class="p">{</span><span class="nx">authorName</span><span class="o">:</span> <span class="s1">&#39;jbl&#39;</span><span class="p">},</span> <span class="nx">include</span><span class="o">:</span> <span class="p">[{</span><span class="nx">model</span><span class="o">:</span> <span class="nx">Book</span><span class="p">}]});</span><span class="c1">//获取作者的所有书</span>
</code></pre></div>
<h2>事务</h2>

<p>Sequelize支持2种事务：</p>

<ul>
<li>自动对Promise链的结果进行提交或回滚，并且把事务传递给所有的回调。</li>
<li>把事务的提交，回滚和传递交给使用者自己来处理。</li>
</ul>

<h3>托管事务</h3>

<p>托管的事务会自动提交或回滚事务，通过传一个回调给<code>sequelize.transaction</code>来开始一个托管的事务。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">return</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// chain all your queries here. make sure you return them.</span>
  <span class="k">return</span> <span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
    <span class="nx">firstName</span><span class="o">:</span> <span class="s1">&#39;Abraham&#39;</span><span class="p">,</span>
    <span class="nx">lastName</span><span class="o">:</span> <span class="s1">&#39;Lincoln&#39;</span>
  <span class="p">},</span> <span class="p">{</span><span class="nx">transaction</span><span class="o">:</span> <span class="nx">t</span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">setShooter</span><span class="p">({</span>
      <span class="nx">firstName</span><span class="o">:</span> <span class="s1">&#39;John&#39;</span><span class="p">,</span>
      <span class="nx">lastName</span><span class="o">:</span> <span class="s1">&#39;Boothe&#39;</span>
    <span class="p">},</span> <span class="p">{</span><span class="nx">transaction</span><span class="o">:</span> <span class="nx">t</span><span class="p">});</span>
  <span class="p">});</span>

<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 此处事务已经提交</span>
  <span class="c1">// result是promise链最后返回的值</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 此处事务以及回滚</span>
  <span class="c1">// err是promise链抛出的异常</span>
<span class="p">});</span>
</code></pre></div>
<p>当使用自动管理的事务时，我们绝不可以手动提交或回滚事务，如果一定要回滚的话，就抛出异常来拒绝promise。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">return</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
    <span class="nx">firstName</span><span class="o">:</span> <span class="s1">&#39;Abraham&#39;</span><span class="p">,</span>
    <span class="nx">lastName</span><span class="o">:</span> <span class="s1">&#39;Lincoln&#39;</span>
  <span class="p">},</span> <span class="p">{</span><span class="nx">transaction</span><span class="o">:</span> <span class="nx">t</span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Woops, the query was successful but we still want to roll back!</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>之前的例子中，事务还是通过<code>{ transaction: t }</code>作为第二个参数传递的。如果想自动把事务传给所有的查询，需要安装<a href="https://github.com/othiym23/node-continuation-local-storage">continuation local storage</a>模块，并在代码中初始化一个namespace。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">cls</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;continuation-local-storage&#39;</span><span class="p">),</span>
    <span class="nx">namespace</span> <span class="o">=</span> <span class="nx">cls</span><span class="p">.</span><span class="nx">createNamespace</span><span class="p">(</span><span class="s1">&#39;my-very-own-namespace&#39;</span><span class="p">);</span>
</code></pre></div>
<p>启用CLS：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">Sequelize</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;sequelize&#39;</span><span class="p">);</span>
<span class="nx">Sequelize</span><span class="p">.</span><span class="nx">cls</span> <span class="o">=</span> <span class="nx">namespace</span><span class="p">;</span>

<span class="k">new</span> <span class="nx">Sequelize</span><span class="p">(....);</span>
</code></pre></div>
<p>注意<code>cls</code>必须设置给Sequelize构造函数，而不是sequelize实例，这样所有的实例都会共用相同的namespace。</p>

<p>CLS就像java中的ThreadLocale一样，这样不同的回调链都可以通过CLS名字空间来访问本地变量。在CLS启用时，当有新的事务创建时，sequelize会把<code>transaction</code>属性设置在名字空间上。因为同一个回调链中的变量都是私有的，其他回调链中访问不到，因此同一时刻会存在多个并非事务。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">sequelize</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">t1</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">namespace</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;transaction&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">t1</span><span class="p">;</span> <span class="c1">// true</span>
<span class="p">});</span>

<span class="nx">sequelize</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">t2</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">namespace</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;transaction&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="nx">t2</span><span class="p">;</span> <span class="c1">// true</span>
<span class="p">});</span>
</code></pre></div>
<p>当然大多数情况下我们不需要直接访问<code>namespace.get(&#39;transaction&#39;)</code>，因为所有的查询会自动在名字空间中查找事务，代码中可以省略事务的显示传递：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">sequelize</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">t1</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// With CLS enabled, the user will be created inside the transaction</span>
  <span class="k">return</span> <span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Alice&#39;</span> <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<h3>事务隔离级别</h3>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">Sequelize</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">.</span><span class="nx">ISOLATION_LEVELS</span><span class="p">.</span><span class="nx">READ_UNCOMMITTED</span> <span class="c1">// &quot;READ UNCOMMITTED&quot;</span>
<span class="nx">Sequelize</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">.</span><span class="nx">ISOLATION_LEVELS</span><span class="p">.</span><span class="nx">READ_COMMITTED</span> <span class="c1">// &quot;READ COMMITTED&quot;</span>
<span class="nx">Sequelize</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">.</span><span class="nx">ISOLATION_LEVELS</span><span class="p">.</span><span class="nx">REPEATABLE_READ</span>  <span class="c1">// &quot;REPEATABLE READ&quot; 这是默认级别</span>
<span class="nx">Sequelize</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">.</span><span class="nx">ISOLATION_LEVELS</span><span class="p">.</span><span class="nx">SERIALIZABLE</span> <span class="c1">// &quot;SERIALIZABLE&quot;</span>
</code></pre></div>
<p>手动设置隔离级别：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">return</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">transaction</span><span class="p">({</span>
  <span class="nx">isolationLevel</span><span class="o">:</span> <span class="nx">Sequelize</span><span class="p">.</span><span class="nx">Transaction</span><span class="p">.</span><span class="nx">ISOLATION_LEVELS</span><span class="p">.</span><span class="nx">SERIALIZABLE</span>
  <span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>

  <span class="c1">// your transactions</span>

  <span class="p">});</span>
</code></pre></div>
<h3>非托管事务</h3>

<p>非托管事务不会自动提交和回滚，它会自动挂起直到超时。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">//不传递回调给transaction()方法来开启一个非托管事务</span>
<span class="k">return</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">transaction</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
    <span class="nx">firstName</span><span class="o">:</span> <span class="s1">&#39;Homer&#39;</span><span class="p">,</span>
    <span class="nx">lastName</span><span class="o">:</span> <span class="s1">&#39;Simpson&#39;</span>
  <span class="p">},</span> <span class="p">{</span><span class="nx">transaction</span><span class="o">:</span> <span class="nx">t</span><span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">user</span><span class="p">.</span><span class="nx">addSibling</span><span class="p">({</span>
      <span class="nx">firstName</span><span class="o">:</span> <span class="s1">&#39;Lisa&#39;</span><span class="p">,</span>
      <span class="nx">lastName</span><span class="o">:</span> <span class="s1">&#39;Simpson&#39;</span>
    <span class="p">},</span> <span class="p">{</span><span class="nx">transaction</span><span class="o">:</span> <span class="nx">t</span><span class="p">});</span>
  <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">commit</span><span class="p">();</span><span class="c1">//手动提交</span>
  <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">rollback</span><span class="p">();</span><span class="c1">//手动回滚</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<h3>事务参数</h3>

<p><code>transaction</code>调用时可以传一个options对象作为第一个参数。</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="k">return</span> <span class="nx">sequelize</span><span class="p">.</span><span class="nx">transaction</span><span class="p">({</span> <span class="cm">/* options */</span> <span class="p">});</span>
</code></pre></div>
<p>可用选项：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="nx">autocommit</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="nx">isolationLevel</span><span class="o">:</span> <span class="s1">&#39;REPEATABLE_READ&#39;</span><span class="p">,</span>
  <span class="nx">deferrable</span><span class="o">:</span> <span class="s1">&#39;NOT DEFERRABLE&#39;</span> <span class="c1">// implicit default of postgres</span>
<span class="p">}</span>
</code></pre></div>
        </section>

        

        <footer class="post-footer">
            <!-- If we want to display author's name and bio -->
            
                <figure class="author-image">
                    <a class="img" href="/" style="background-image: url(/assets/images/profile.png)">
                    <span class="hidden">dchjmichael's Picture</span></a>
                </figure>
                <section class="author">
                    <!-- Author Name -->
                    <h4> dchjmichael </h4>
                    <!-- Author Bio -->
                    <p>
                        Code Farmer
                    </p>
                </section>
            

            <!-- Share links section -->
            <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?text=NodeJS ORM框架Sequelize学习笔记&amp;url=https://dchjmichael.github.io/nodejs/orm/sequelize/2016/03/10/sequelize.html"
        onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://dchjmichael.github.io/nodejs/orm/sequelize/2016/03/10/sequelize.html"
        onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=https://dchjmichael.github.io/nodejs/orm/sequelize/2016/03/10/sequelize.html"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>

            <!-- Disqus comments -->
           
                <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">

        var disqus_shortname = 'joeytai'; 
        var disqus_developer = 0; // developer mode is on
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
           

        </footer>

    </article>

</main>

    <footer class="site-footer clearfix">
      <section class="copyright">
        <a href="/">Joey's Blog</a> &copy; 
               &bull; All rights reserved.
      </section>
      <section class="poweredby">Made with Jekyll using 
        <a href="http://github.com/rosario/kasper">Kasper theme</a>
      </section>
    </footer>
    
    <script type="text/javascript" src="/assets/js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-74976002-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>   
</body>
</html>
